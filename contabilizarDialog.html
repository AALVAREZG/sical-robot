<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Contabilizar Operaciones</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        h1 {
            margin: 0;
            color: #333;
        }
        .bank-operation {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #4285F4;
        }
        .bank-operation-details {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .bank-operation-field {
            font-weight: bold;
            color: #555;
        }
        .accounting-tasks {
            margin-top: 20px;
        }
        .task-card {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .task-type {
            background-color: #E1F5FE;
            color: #0277BD;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .task-type.arqueo {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        .task-type.ado220 {
            background-color: #FFF8E1;
            color: #FF8F00;
        }
        .controls {
            text-align: right;
            margin: 20px 0;
        }
        button {
            padding: 8px 15px;
            background-color: #4285F4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: 500;
        }
        button:hover {
            background-color: #3367D6;
        }
        button.secondary {
            background-color: #f1f1f1;
            color: #333;
        }
        button.secondary:hover {
            background-color: #e4e4e4;
        }
        button.delete {
            background-color: #F44336;
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 3px 8px;
            font-size: 12px;
        }
        button.delete:hover {
            background-color: #D32F2F;
        }
        .task-detail-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 5px;
        }
        .field-label {
            font-size: 12px;
            color: #666;
        }
        .field-value {
            font-weight: 500;
        }
        .edit-button {
            background-color: #f1f1f1;
            color: #333;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }
        .edit-button:hover {
            background-color: #e4e4e4;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-field {
            margin-bottom: 10px;
        }
        .form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-field input, .form-field select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }
        .task-add-btn {
            background-color: #4CAF50;
            margin: 10px 0;
        }
        .ai-suggestion {
            background-color: #E3F2FD;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #2196F3;
        }
        .ai-suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .ai-icon {
            font-weight: bold;
            color: #2196F3;
        }
        .suggestion-actions {
            display: flex;
            gap: 10px;
        }
        /* Debug Console Styles */
        #debugConsole {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 400px;
            max-height: 300px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            overflow-y: auto;
            z-index: 9999;
            border-top-left-radius: 5px;
            display: none;
        }
        
        #debugConsole.visible {
            display: block;
        }
        
        #debugToggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            z-index: 10000;
        }
        
        .debug-line {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 3px 0;
        }
        
        .debug-error {
            color: #ff5252;
        }
        
        .debug-warn {
            color: #ffca28;
        }
        
        .debug-info {
            color: #4fc3f7;
        }
      

        .ai-suggestion-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        #patternDisplay {
            font-size: 14px;
            color: #555;
        }
        
        #selectedPattern {
            font-weight: bold;
            color: #2196F3;
        }
</style>
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Contabilizar Operaciones</h1>
            <div>
                <!--<button id="trainAIBtn" class="secondary">Entrenar IA</button>-->
                <button id="saveBtn">Guardar</button>
            </div>
        </div>
        
        <div class="bank-operation">
            <h3>Operaci√≥n Bancaria</h3>
            <div class="bank-operation-details">
                <div>
                    <div class="bank-operation-field">CAJA</div>
                    <div id="bankBox"></div>
                </div>
                <div>
                    <div class="bank-operation-field">FECHA</div>
                    <div id="bankDate"></div>
                </div>
                <div>
                    <div class="bank-operation-field">CONCEPTO</div>
                    <div id="bankConcept"></div>
                </div>
                <div>
                    <div class="bank-operation-field">IMPORTE</div>
                    <div id="bankAmount"></div>
                </div>
                <div>
                    <div class="bank-operation-field">SALDO</div>
                    <div id="bankBalance"></div>
                </div>
            </div>
            
            <!-- Update the AI suggestion section to include the selected pattern -->
        <div class="ai-suggestion">
            <div class="ai-suggestion-header">
                <div class="ai-icon">ü§ñ Sugerencia de IA</div>
                <div class="suggestion-actions">
                    <button id="acceptAllBtn">Aceptar Todo</button>
                    <button id="rejectAllBtn" class="secondary">Rechazar</button>
                </div>
            </div>
            <div class="ai-suggestion-info">
                <div id="aiSuggestionCount"></div>
                <div id="patternDisplay">Patr√≥n seleccionado: <span id="selectedPattern">Ninguno</span></div>
            </div>
        </div>
        </div>
        
        <div class="accounting-tasks">
            <h3>Tareas Contables</h3>
            <div id="taskContainer"></div>
            
            <button id="addTaskBtn" class="task-add-btn">A√±adir Tarea</button>
        </div>
        
        <div class="controls">
            <button id="cancelBtn" class="secondary">Cancelar</button>
            <button id="confirmBtn">Confirmar</button>
        </div>
    </div>
    
    <!-- Debug Console -->
    <div id="debugConsole">DEBUG</div>
    <button id="debugToggle">CLKüêû</button>
    
    <!-- Edit Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Editar Tarea</h2>
            
            <div class="form-field">
                <label for="taskType">Tipo de Tarea</label>
                <select id="taskType">
                    <option value="arqueo">Arqueo</option>
                    <option value="ado220">ADO</option>
                    <!-- Add other task types as needed -->
                </select>
            </div>
            
            <!-- Dynamic form fields based on task type will be inserted here -->
            <div id="dynamicFormFields"></div>
            
            <div class="modal-footer">
                <button id="cancelModalBtn" class="secondary">Cancelar</button>
                <button id="saveModalBtn">Guardar</button>
            </div>
        </div>
    </div>
    
    <script>
        // Get the electron modules
        const { ipcRenderer } = require('electron');
        
        // Bank operation data (would be passed from main process)
        let bankData = [];
        let originalTasksData = null;
        let tasksData = {
            num_operaciones: 0,
            liquido_operaciones: 0,
            operaciones: []
        };
        
        // DOM elements
        const taskContainer = document.getElementById('taskContainer');
        const bankBox = document.getElementById('bankBox');
        const bankDate = document.getElementById('bankDate');
        const bankConcept = document.getElementById('bankConcept');
        const bankAmount = document.getElementById('bankAmount');
        const bankBalance = document.getElementById('bankBalance');
        const aiSuggestionCount = document.getElementById('aiSuggestionCount');
        
        // Modal elements
        const taskModal = document.getElementById('taskModal');
        const modalTitle = document.getElementById('modalTitle');
        const taskType = document.getElementById('taskType');
        const dynamicFormFields = document.getElementById('dynamicFormFields');
        const closeModalBtn = document.querySelector('.close');
        const saveModalBtn = document.getElementById('saveModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        
        // Buttons
        const addTaskBtn = document.getElementById('addTaskBtn');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const acceptAllBtn = document.getElementById('acceptAllBtn');
        const rejectAllBtn = document.getElementById('rejectAllBtn');
        const trainAIBtn = document.getElementById('trainAIBtn');
        const saveBtn = document.getElementById('saveBtn');
        
        // Init function - called when page loads
        async function init() {
            console.log('Initializing...');
            
            // Get data from main process
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const operationId = urlParams.get('id');
                
                console.log('Operation ID:', operationId);
                
                // Get bank operation data
                bankData = await ipcRenderer.invoke('get-bank-operation', operationId);
                console.log('Bank data received:', bankData);
                
                // Display bank operation details
                displayBankOperation(bankData);
                
                // Get AI suggestion
                console.log('Requesting AI translation...');
                const aiSuggestion = await ipcRenderer.invoke('translate-operation', bankData);
                console.log('AI suggestion received:', aiSuggestion);
                
                originalTasksData = JSON.parse(JSON.stringify(aiSuggestion)); // Deep copy
                
                // Store AI suggestion
                tasksData = aiSuggestion.data;
                
                // Display AI suggestion count
                aiSuggestionCount.textContent = `La IA ha sugerido ${tasksData.num_operaciones} operaciones contables para esta transacci√≥n bancaria.`;

                // Update the pattern display if available in the response
                if (aiSuggestion.description) {
                    updateSelectedPattern(aiSuggestion.description);
                }
                
                // Render tasks
                renderTasks();
                
                console.log('Initialization complete');
            } catch (error) {
                console.error('Error initializing:', error);
                alert('Error al cargar los datos: ' + error.message);
            }
        }
        
        // Display bank operation details
        function displayBankOperation(data) {
            console.log('Displaying bank operation:', data);
            
            const [caja, fecha, concepto, importe, saldo] = data;
            bankBox.textContent = caja;
            bankDate.textContent = fecha;
            bankConcept.textContent = concepto;
            bankAmount.textContent = importe;
            bankBalance.textContent = saldo;
        }
        
        // Render all tasks
        function renderTasks() {
            console.log('Rendering tasks:', tasksData.operaciones.length);
            
            taskContainer.innerHTML = '';
            
            tasksData.operaciones.forEach((task, index) => {
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';
                
                // Create task header
                const taskHeader = document.createElement('div');
                taskHeader.className = 'task-header';
                
                // Task type badge
                const taskType = document.createElement('div');
                taskType.className = 'task-type ' + task.tipo;
                taskType.textContent = task.tipo.toUpperCase();
                
                // Edit button
                const editButton = document.createElement('div');
                editButton.className = 'edit-button';
                editButton.textContent = 'Editar';
                editButton.addEventListener('click', () => openEditModal(index));
                
                taskHeader.appendChild(taskType);
                taskHeader.appendChild(editButton);
                
                // Delete button
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete';
                deleteButton.textContent = '‚úï';
                deleteButton.addEventListener('click', () => deleteTask(index));
                
                // Create task details based on task type
                const taskDetails = document.createElement('div');
                taskDetails.className = 'task-details';
                
                if (task.tipo === 'arqueo') {
                    // For arqueo type
                    const detailRow1 = createDetailRow([
                        { label: 'Fecha', value: task.detalle.fecha },
                        { label: 'Caja', value: task.detalle.caja },
                        { label: 'Tercero', value: task.detalle.tercero },
                        { label: 'Naturaleza', value: task.detalle.naturaleza }
                    ]);
                    
                    const partidas = task.detalle.final.map(p => `${p.partida}: ${p.IMPORTE_PARTIDA}`).join(', ');
                    const detailRow2 = createDetailRow([
                        { label: 'Partidas', value: partidas, colspan: 4 }
                    ]);
                    
                    const textoSical = task.detalle.texto_sical.map(t => t.tcargo).join('\n');
                    const detailRow3 = createDetailRow([
                        { label: 'Texto SICAL', value: textoSical, colspan: 4 }
                    ]);
                    
                    taskDetails.appendChild(detailRow1);
                    taskDetails.appendChild(detailRow2);
                    taskDetails.appendChild(detailRow3);
                } else if (task.tipo === 'ado220') {
                    // For ado220 type
                    const detailRow1 = createDetailRow([
                        { label: 'Fecha', value: task.detalle.fecha },
                        { label: 'Expediente', value: task.detalle.expediente },
                        { label: 'Tercero', value: task.detalle.tercero },
                        { label: 'Caja', value: task.detalle.caja }
                    ]);
                    
                    const detailRow2 = createDetailRow([
                        { label: 'F. Pago', value: task.detalle.fpago },
                        { label: 'T. Pago', value: task.detalle.tpago },
                        { label: 'Texto', value: task.detalle.texto, colspan: 2 }
                    ]);
                    
                    const aplicaciones = task.detalle.aplicaciones.map(a => 
                        `${a.funcional}-${a.economica}: ${a.importe}‚Ç¨ (${a.cuenta})`).join('\n');
                    
                    const detailRow3 = createDetailRow([
                        { label: 'Aplicaciones', value: aplicaciones, colspan: 4 }
                    ]);
                    
                    taskDetails.appendChild(detailRow1);
                    taskDetails.appendChild(detailRow2);
                    taskDetails.appendChild(detailRow3);
                }
                
                // Assemble the task card
                taskCard.appendChild(taskHeader);
                taskCard.appendChild(deleteButton);
                taskCard.appendChild(taskDetails);
                
                // Add to container
                taskContainer.appendChild(taskCard);
            });
        }
        
        // Create a detail row with fields
        function createDetailRow(fields) {
            const row = document.createElement('div');
            row.className = 'task-detail-row';
            
            fields.forEach(field => {
                const cell = document.createElement('div');
                if (field.colspan) {
                    cell.style.gridColumn = `span ${field.colspan}`;
                }
                
                const label = document.createElement('div');
                label.className = 'field-label';
                label.textContent = field.label;
                
                const value = document.createElement('div');
                value.className = 'field-value';
                value.textContent = field.value;
                
                cell.appendChild(label);
                cell.appendChild(value);
                row.appendChild(cell);
            });
            
            return row;
        }
        
        // Open modal to edit a task
        function openEditModal(index) {
            console.log('Opening edit modal for task index:', index);
            
            modalTitle.textContent = index >= 0 ? 'Editar Tarea' : 'A√±adir Tarea';
            
            // Set current task type or default
            const currentTask = index >= 0 ? tasksData.operaciones[index] : { tipo: 'arqueo', detalle: {} };
            taskType.value = currentTask.tipo;
            
            // Generate dynamic form fields based on task type
            generateFormFields(currentTask);
            
            // Store the task index for saving
            saveModalBtn.dataset.taskIndex = index;
            
            // Show the modal
            taskModal.style.display = 'block';
        }
        
        // Generate form fields based on task type
        function generateFormFields(task) {
            console.log('Generating form fields for task type:', task.tipo);
            
            dynamicFormFields.innerHTML = '';
            
            if (task.tipo === 'arqueo') {
                // Fields for arqueo type
                const formGrid = document.createElement('div');
                formGrid.className = 'form-grid';
                
                // Basic fields
                formGrid.appendChild(createFormField('fecha', 'Fecha', task.detalle.fecha || ''));
                formGrid.appendChild(createFormField('caja', 'Caja', task.detalle.caja || ''));
                formGrid.appendChild(createFormField('tercero', 'Tercero', task.detalle.tercero || ''));
                formGrid.appendChild(createFormField('naturaleza', 'Naturaleza', task.detalle.naturaleza || ''));
                
                // Partidas section
                const partidasSection = document.createElement('div');
                partidasSection.style.gridColumn = 'span 2';
                
                const partidasLabel = document.createElement('h4');
                partidasLabel.textContent = 'Partidas';
                partidasSection.appendChild(partidasLabel);
                
                // Add partida fields
                const partidas = task.detalle.final || [{ partida: '', IMPORTE_PARTIDA: 0 }];
                partidas.forEach((partida, i) => {
                    const partidaRow = document.createElement('div');
                    partidaRow.style.display = 'flex';
                    partidaRow.style.gap = '10px';
                    partidaRow.style.marginBottom = '10px';
                    
                    const partidaField = createFormField(`partida_${i}`, 'Partida', partida.partida);
                    partidaField.style.flex = '1';
                    
                    const importeField = createFormField(`importe_partida_${i}`, 'Importe', partida.IMPORTE_PARTIDA);
                    importeField.style.flex = '1';
                    
                    partidaRow.appendChild(partidaField);
                    partidaRow.appendChild(importeField);
                    partidasSection.appendChild(partidaRow);
                });
                
                // Texto SICAL section
                const textoSection = document.createElement('div');
                textoSection.style.gridColumn = 'span 2';
                
                const textoLabel = document.createElement('h4');
                textoLabel.textContent = 'Texto SICAL';
                textoSection.appendChild(textoLabel);
                
                // Add texto fields
                const textos = task.detalle.texto_sical || [{ tcargo: '', ado: '' }];
                textos.forEach((texto, i) => {
                    const textoRow = document.createElement('div');
                    
                    const tcargoField = createFormField(`tcargo_${i}`, 'T.Cargo', texto.tcargo);
                    const adoField = createFormField(`ado_${i}`, 'ADO', texto.ado);
                    
                    textoRow.appendChild(tcargoField);
                    textoRow.appendChild(adoField);
                    textoSection.appendChild(textoRow);
                });
                
                formGrid.appendChild(partidasSection);
                formGrid.appendChild(textoSection);
                dynamicFormFields.appendChild(formGrid);
                
            } else if (task.tipo === 'ado220') {
                // Fields for ado220 type
                const formGrid = document.createElement('div');
                formGrid.className = 'form-grid';
                
                // Basic fields
                formGrid.appendChild(createFormField('fecha', 'Fecha', task.detalle.fecha || ''));
                formGrid.appendChild(createFormField('expediente', 'Expediente', task.detalle.expediente || ''));
                formGrid.appendChild(createFormField('tercero', 'Tercero', task.detalle.tercero || ''));
                formGrid.appendChild(createFormField('caja', 'Caja', task.detalle.caja || ''));
                formGrid.appendChild(createFormField('fpago', 'F.Pago', task.detalle.fpago || ''));
                formGrid.appendChild(createFormField('tpago', 'T.Pago', task.detalle.tpago || ''));
                
                const textoField = createFormField('texto', 'Texto', task.detalle.texto || '');
                textoField.style.gridColumn = 'span 2';
                formGrid.appendChild(textoField);
                
                // Aplicaciones section
                const aplicacionesSection = document.createElement('div');
                aplicacionesSection.style.gridColumn = 'span 2';
                
                const aplicacionesLabel = document.createElement('h4');
                aplicacionesLabel.textContent = 'Aplicaciones';
                aplicacionesSection.appendChild(aplicacionesLabel);
                
                // Add aplicacion fields
                const aplicaciones = task.detalle.aplicaciones || [{ funcional: '', economica: '', gfa: null, importe: '', cuenta: '' }];
                aplicaciones.forEach((aplicacion, i) => {
                    const aplicacionGrid = document.createElement('div');
                    aplicacionGrid.style.display = 'grid';
                    aplicacionGrid.style.gridTemplateColumns = '1fr 1fr 1fr 1fr 1fr';
                    aplicacionGrid.style.gap = '10px';
                    aplicacionGrid.style.marginBottom = '15px';
                    
                    aplicacionGrid.appendChild(createFormField(`funcional_${i}`, 'Funcional', aplicacion.funcional));
                    aplicacionGrid.appendChild(createFormField(`economica_${i}`, 'Econ√≥mica', aplicacion.economica));
                    aplicacionGrid.appendChild(createFormField(`gfa_${i}`, 'GFA', aplicacion.gfa || ''));
                    aplicacionGrid.appendChild(createFormField(`importe_${i}`, 'Importe', aplicacion.importe));
                    aplicacionGrid.appendChild(createFormField(`cuenta_${i}`, 'Cuenta', aplicacion.cuenta));
                    
                    aplicacionesSection.appendChild(aplicacionGrid);
                });
                
                formGrid.appendChild(aplicacionesSection);
                dynamicFormFields.appendChild(formGrid);
            }
        }
        
        // Create form field with label and input
        function createFormField(id, label, value) {
            const field = document.createElement('div');
            field.className = 'form-field';
            
            const labelEl = document.createElement('label');
            labelEl.htmlFor = id;
            labelEl.textContent = label;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.id = id;
            input.value = value;
            
            field.appendChild(labelEl);
            field.appendChild(input);
            
            return field;
        }
        
        // Delete a task
        function deleteTask(index) {
            console.log('Attempting to delete task at index:', index);
            
            if (confirm('¬øEst√° seguro de que desea eliminar esta tarea?')) {
                tasksData.operaciones.splice(index, 1);
                tasksData.num_operaciones = tasksData.operaciones.length;
                console.log('Task deleted, remaining tasks:', tasksData.operaciones.length);
                renderTasks();
            }
        }
        
        // Save task from modal
        function saveTaskFromModal() {
            console.log('Saving task from modal');
            
            const index = parseInt(saveModalBtn.dataset.taskIndex);
            const newTask = {
                tipo: taskType.value,
                detalle: {}
            };
            
            // Collect form data based on task type
            if (taskType.value === 'arqueo') {
                newTask.detalle = {
                    fecha: document.getElementById('fecha').value,
                    caja: document.getElementById('caja').value,
                    tercero: document.getElementById('tercero').value,
                    naturaleza: document.getElementById('naturaleza').value,
                    final: [],
                    texto_sical: []
                };
                
                // Collect partidas
                let i = 0;
                while (document.getElementById(`partida_${i}`)) {
                    newTask.detalle.final.push({
                        partida: document.getElementById(`partida_${i}`).value,
                        IMPORTE_PARTIDA: parseFloat(document.getElementById(`importe_partida_${i}`).value)
                    });
                    i++;
                }
                
                // Collect texto_sical
                i = 0;
                while (document.getElementById(`tcargo_${i}`)) {
                    newTask.detalle.texto_sical.push({
                        tcargo: document.getElementById(`tcargo_${i}`).value,
                        ado: document.getElementById(`ado_${i}`).value
                    });
                    i++;
                }
            } else if (taskType.value === 'ado220') {
                newTask.detalle = {
                    fecha: document.getElementById('fecha').value,
                    expediente: document.getElementById('expediente').value,
                    tercero: document.getElementById('tercero').value,
                    caja: document.getElementById('caja').value,
                    fpago: document.getElementById('fpago').value,
                    tpago: document.getElementById('tpago').value,
                    texto: document.getElementById('texto').value,
                    aplicaciones: []
                };
                
                // Collect aplicaciones
                let i = 0;
                while (document.getElementById(`funcional_${i}`)) {
                    newTask.detalle.aplicaciones.push({
                        funcional: document.getElementById(`funcional_${i}`).value,
                        economica: document.getElementById(`economica_${i}`).value,
                        gfa: document.getElementById(`gfa_${i}`).value || null,
                        importe: document.getElementById(`importe_${i}`).value,
                        cuenta: document.getElementById(`cuenta_${i}`).value
                    });
                    i++;
                }
            }
            
            console.log('New task data:', newTask);
            
            // Add or update task
            if (index >= 0) {
                tasksData.operaciones[index] = newTask;
            } else {
                tasksData.operaciones.push(newTask);
            }
            
            // Update task count
            tasksData.num_operaciones = tasksData.operaciones.length;
            
            // Recalculate total amount
            calculateTotalAmount();
            
            // Close modal and re-render
            closeModal();
            renderTasks();
        }
        
        // Calculate total amount from all tasks
        function calculateTotalAmount() {
            let total = 0;
            
            tasksData.operaciones.forEach(task => {
                if (task.tipo === 'arqueo') {
                    task.detalle.final.forEach(partida => {
                        if (partida.partida !== 'Total') {
                            total += parseFloat(partida.IMPORTE_PARTIDA) || 0;
                        }
                    });
                } else if (task.tipo === 'ado220') {
                    task.detalle.aplicaciones.forEach(aplicacion => {
                        total += parseFloat(aplicacion.importe) || 0;
                    });
                }
            });
            
            tasksData.liquido_operaciones = total;
            console.log('Total amount calculated:', total);
        }
        
        // Close the modal
        function closeModal() {
            console.log('Closing modal');
            taskModal.style.display = 'none';
        }
        
        // Accept all AI suggestions
        function acceptAllSuggestions() {
            console.log('Accepting all AI suggestions');
            // AI suggestions are already loaded in tasksData
            renderTasks();
        }
        
        // Reject all AI suggestions
        function rejectAllSuggestions() {
            console.log('Rejecting all AI suggestions');
            // Clear all AI suggestions
            tasksData.operaciones = [];
            tasksData.num_operaciones = 0;
            tasksData.liquido_operaciones = 0;
            renderTasks();
        }
        
        function updateSelectedPattern(patternName) {
            const selectedPatternElement = document.getElementById('selectedPattern');
            if (selectedPatternElement) {
                selectedPatternElement.textContent = patternName || 'Ninguno..';
        }
}
              
        // Save translation to file
        async function saveTranslation() {
            try {
                console.log('Saving translation to file');
                // Use ipcRenderer to communicate with main process
                const result = await ipcRenderer.invoke('show-save-dialog-and-save', tasksData);
                
                if (result.success) {
                    alert('Traducci√≥n guardada correctamente');
                } else {
                    alert('Error al guardar la traducci√≥n: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving translation:', error);
                alert('Error al guardar la traducci√≥n: ' + error.message);
            }
        }
        
        // Submit and close dialog
        function submitAndClose() {
            console.log('Submitting tasks and closing dialog');
            // Send data back to main process using the responseChannel set by the main process
            if (window.responseChannel) {
                console.log('Using response channel:', window.responseChannel);
                ipcRenderer.send(window.responseChannel, tasksData);
                window.close();
            } else {
                // Fallback to the original method if responseChannel is not set
                // This is less ideal but provides backward compatibility
                console.warn('Response channel not set, using fallback method');
                ipcRenderer.invoke('submit-tasks', tasksData)
                    .then(() => {
                        window.close();
                    })
                    .catch(error => {
                        console.error('Error submitting tasks:', error);
                        alert('Error al enviar las tareas: ' + error.message);
                    });
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM content loaded, initializing...');
            
            // Ensure all DOM elements are available before setting event handlers
            setTimeout(() => {
                console.log('Setting up event listeners');
                
                // Modal events
                if (closeModalBtn) {
                    console.log('Adding closeModalBtn listener');
                    closeModalBtn.addEventListener('click', closeModal);
                }
                
                if (cancelModalBtn) {
                    console.log('Adding cancelModalBtn listener');
                    cancelModalBtn.addEventListener('click', closeModal);
                }
                
                if (saveModalBtn) {
                    console.log('Adding saveModalBtn listener');
                    saveModalBtn.addEventListener('click', saveTaskFromModal);
                }
                
                // Task type change event
                if (taskType) {
                    console.log('Adding taskType change listener');
                    taskType.addEventListener('change', function() {
                        // Get current task data (if editing) or create empty one
                        const index = parseInt(saveModalBtn.dataset.taskIndex);
                        const currentTask = index >= 0 ? tasksData.operaciones[index] : { tipo: taskType.value, detalle: {} };
                        
                        // Update task type
                        currentTask.tipo = taskType.value;
                        
                        // Regenerate form fields
                        generateFormFields(currentTask);
                    });
                }
                
                // Button events
                if (addTaskBtn) {
                    console.log('Adding addTaskBtn listener');
                    addTaskBtn.addEventListener('click', () => openEditModal(-1));
                }
                
                if (confirmBtn) {
                    console.log('Adding confirmBtn listener');
                    confirmBtn.addEventListener('click', submitAndClose);
                }
                
                if (cancelBtn) {
                    console.log('Adding cancelBtn listener');
                    cancelBtn.addEventListener('click', () => window.close());
                }
                
                if (acceptAllBtn) {
                    console.log('Adding acceptAllBtn listener');
                    acceptAllBtn.addEventListener('click', acceptAllSuggestions);
                }
                
                if (rejectAllBtn) {
                    console.log('Adding rejectAllBtn listener');
                    rejectAllBtn.addEventListener('click', rejectAllSuggestions);
                }
                
                if (trainAIBtn) {
                    console.log('Adding trainAIBtn listener');
                    trainAIBtn.addEventListener('click', () => {
                        console.log('Train AI button clicked');
                        trainAI();
                    });
                }
                
                if (saveBtn) {
                    console.log('Adding saveBtn listener');
                    saveBtn.addEventListener('click', () => {
                        console.log('Save button clicked');
                        saveTranslation();
                    });
                }
                
                // When user clicks outside the modal, close it
                window.onclick = function(event) {
                    if (event.target === taskModal) {
                        closeModal();
                    }
                };
                
                // Run initialization
                init();
            }, 100);
        });
        
        // Setup debug console
        function setupDebugConsole() {
            const debugConsole = document.getElementById('debugConsole');
            const debugToggle = document.getElementById('debugToggle');
            let isConsoleVisible = true;
            
            // Toggle console visibility
            debugToggle.addEventListener('click', () => {
                isConsoleVisible = !isConsoleVisible;
                debugConsole.className = isConsoleVisible ? 'visible' : '';
            });
            
            // Override console methods
            const originalConsole = {
                log: console.log,
                error: console.error,
                warn: console.warn,
                info: console.info
            };
            
            // Function to add message to debug console
            function addMessage(type, args) {
                const line = document.createElement('div');
                line.className = 'debug-line debug-' + type;
                
                const timestamp = new Date().toLocaleTimeString();
                const message = Array.from(args).map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                
                line.textContent = `[${timestamp}] ${message}`;
                debugConsole.appendChild(line);
                
                // Auto-scroll to bottom
                debugConsole.scrollTop = debugConsole.scrollHeight;
            }
            
            // Override console methods
            console.log = function() {
                addMessage('log', arguments);
                originalConsole.log.apply(console, arguments);
            };
            
            console.error = function() {
                addMessage('error', arguments);
                originalConsole.error.apply(console, arguments);
            };
            
            console.warn = function() {
                addMessage('warn', arguments);
                originalConsole.warn.apply(console, arguments);
            };
            
            console.info = function() {
                addMessage('info', arguments);
                originalConsole.info.apply(console, arguments);
            };
            
            // Add initial message
            console.info('Debug console initialized');
        }
        
        // Initialize debug console
        setupDebugConsole();
    </script>
</body>
</html>