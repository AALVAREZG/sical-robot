document.addEventListener('DOMContentLoaded', () => {
    const addArqueoButton = document.getElementById('addArqueo');
    const addGastoButton = document.getElementById('addGasto');
    const operacionesTable = document.getElementById('operacionesTable').getElementsByTagName('tbody')[0];
    const saveOperacionesButton = document.getElementById('saveOperaciones');
    const formContainer = document.getElementById('formContainer');

    let operaciones = [];

    function showForm(type) {
        const form = createForm(type);
        formContainer.innerHTML = '';
        formContainer.appendChild(form);
        formContainer.style.display = 'block';
    }

    function createForm(type) {
        const form = document.createElement('form');
        form.id = `${type}Form`;
        form.innerHTML = `
            <h3>${type === 'arqueo' ? 'Arqueo' : 'Gasto'}</h3>
            <div class="form-group">
                <label for="${type}_fecha">Fecha:</label>
                <input type="date" id="${type}_fecha" name="fecha" required>
            </div>
            <div class="form-group">
                <label for="${type}_importe">Importe:</label>
                <input type="number" id="${type}_importe" name="importe" required>
            </div>
            ${type === 'arqueo' ? `
                <div class="form-group">
                    <label for="arqueo_caja">Caja:</label>
                    <input type="text" id="arqueo_caja" name="caja" required>
                </div>
                <div class="form-group">
                    <label for="arqueo_tercero">Tercero:</label>
                    <input type="text" id="arqueo_tercero" name="tercero" required>
                </div>
            ` : `
                <div class="form-group">
                    <label for="gasto_concepto">Concepto:</label>
                    <input type="text" id="gasto_concepto" name="concepto" required>
                </div>
            `}
            <button type="submit">Guardar ${type === 'arqueo' ? 'Arqueo' : 'Gasto'}</button>
        `;

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const operacion = {
                type: type,
                fecha: formData.get('fecha'),
                importe: formData.get('importe'),
                ...Object.fromEntries(formData)
            };
            addOperacion(operacion);
            formContainer.style.display = 'none';
        });

        return form;
    }

    function addOperacion(operacion) {
        operaciones.push(operacion);
        const newRow = operacionesTable.insertRow();
        newRow.innerHTML = `
            <td>${operacion.type}</td>
            <td>${operacion.fecha}</td>
            <td>${operacion.importe}</td>
            <td>
                <button onclick="editOperacion(${operaciones.length - 1})">Editar</button>
                <button onclick="deleteOperacion(${operaciones.length - 1})">Eliminar</button>
            </td>
        `;
    }

    function editOperacion(index) {
        const operacion = operaciones[index];
        showForm(operacion.type);
        const form = document.getElementById(`${operacion.type}Form`);
        Object.keys(operacion).forEach(key => {
            const input = form.elements[key];
            if (input) input.value = operacion[key];
        });
        operaciones.splice(index, 1);
        operacionesTable.deleteRow(index);
    }

    function deleteOperacion(index) {
        operaciones.splice(index, 1);
        operacionesTable.deleteRow(index);
    }

    addArqueoButton.addEventListener('click', () => showForm('arqueo'));
    addGastoButton.addEventListener('click', () => showForm('gasto'));

    saveOperacionesButton.addEventListener('click', async () => {
        try {
            await window.electronAPI.saveContableTask(operaciones);
            window.close();
        } catch (error) {
            console.error("Error saving operations:", error);
        }
    });

    // Exponer funciones al Ã¡mbito global para los botones de la tabla
    window.editOperacion = editOperacion;
    window.deleteOperacion = deleteOperacion;
});